# 20. 리다이렉션과 부하 균형

## 1. 리다이렉트

리다이렉션은 현대 웹에서 피할 수 없는 현실이다. 리다이렉트는 아래 세가지를 충족시켜준다.

- 신뢰할 수 있는 HTTP 트랜잭션
- 지연 최소화
- 네트워크 대역폭 절약

이것 외에도 몇가지 방식을 통해 부하 균형을 하게 된다.

## 2. 리다이렉트 할 곳

서버, 프록시, 캐시, 게이트웨이 등은 클라이언트에게 모두 동일하게 보여진다. (요청을 보내고 응답을 받고)

그렇기 때문에 리다이렉션 기법 또한 대부분 동일하다.

## 3. 리다이렉션 프로토콜 개요

리다이렉션은 HTTP 애플리케이션과 라우팅 장치의 영향을 받는다.

- 사용자는 클라이언트 메시지를 프록시 서버로 보내도록 설정할 수 있다.
- DNS resolver는 메시지 주소를 지정할 때 IP를 사용하는데 이는 클라이언트에 따라 달라질 수 있다.
- 메시지는 여러 패킷으로 나뉘어 전송되는데 패킷을 어떻게 라우팅 할 것인지 결정한다.
- 웹 서버는 HTTP 리다이렉트를 통해 다른 웹서버로 요청을 보낼 수 있다.

HTTP, DNS, MAC, IP, 프록시, 캐시등 리다이렉션 방법은 많다. 추후에 자세히 알아보자.

## 4. 일반적인 리다이렉션 방법

### 4.1 HTTP 리다이렉션

HTTP 302 코드를 통해 리다이렉트를 응답한다. 

특징

- 이 방법은 클라이언트의 IP를 알고 리다이렉션 해서 정보에 근거한 선택을 할 수 있다.
- 리다이렉트 결정 로직 또한 부하가 된다.
- 요청과 응답이 N배가 되기 때문에 그만큼 느리다.
- 리다이렉트 서버에 의존적이다.

### 4.2 DNS 리다이렉션

웹에 접근할 때 DNS 서버를 통해 IP 주소를 알아낸다. DNS resolver는 여러 IP를 반환하거나 특정 IP를 반환하도록 프로그래밍이 가능하다. 간단하게 라운드 로빈부터 서버 부하를 확인하고 분산하는 방법까지 다양하다.

- 라운드 로빈은 서버의 상태와 상관 없이 간단하게 번갈아가며 IP를 반환하는 방식이다. (캐싱되기도 한다)
- 부하 균형 방식은 웹 서버의 로드를 추적하고 로드가 가장 적은 IP를 반환하는 방식이다.
- 근접 라우팅 알고리즘은 지리적으로 근처의 IP를 반환하는 방식이다.
- 결함 마스킹 알고리즘은 서버의 헬스를 체크하고, 불안전한 서버를 건너뛰고 IP를 반환하는 방식이다.

### 4.3 임의 캐스트 어드레싱

백본 라우터의 최단거리 라우팅 능력에 의지하는 방법이다. 즉, 지리적으로 가까운 서버에 라우팅된다.

### 4.4 IP, MAC 포워딩

레이어4를 이해하는 스위치는 레이어4의 주소 (IP, 포트번호)를 검사하여 라우팅 한다.

일반적으로 80번 포트는 MAC6(프록시 캐시)로 보내지고, 그 외의 모든 트래픽은 MAC5로 간다.

### 4.5 IP 주소 포워딩 (NAT)

TCP 패킷에 적힌 목적지 IP 주소에 따라 라우팅한다. 스위치를 한 번 지난 IP는 그대로 저장되어 응답도 해당 서버로 돌아가게 된다.

### 4.6 네트워크 구성요소 제어 프로토콜(NECP)

라우터나 스위치 같은 네트워크 구성 요소와(NE), 프록시나 캐시같이 애플리케이션 계층 요청을 처리하는 구성 요소가(SE) 대화할 수 있게 해준다. SE가 적합하다고 판단한 대로 NE가 부하 균형을 유지할 수 있도록 한다.

MAC 포워딩, GRE 캡슐화, NAT 같은 방법을 제공한다.

## 5. 프록시 리다이렉션

보안상 이유로 프록시를 경우하거나, 프록시에 캐시가 있는 경우 웹 브라우저는 어떻게 프록시 경로를 알까?

아래 세가지 기법을 통해 알게된다.

### 5.1 명시적 브라우저 설정

대부분의 브라우저는 프록시 이름, IP, 포트번호를 설정할 수 있다. 이렇게 사용하면 모든 요청을 프록시에 접촉한다.

단점

- 프록시가 응답하지 않으면, 원서버와 접촉하지 않는다.
- 네트워크 아키텍처가 변경되었을 때 프록시 설정도 변경해야 한다.

### 5.2 프록시 자동 설정

바로 위의 단점을 해결하는 방법이다. PAC 프로토콜이라고도 불리는데 URL별로 접촉해야 할 프록시를 지정한 PAC 파일을 찾아 요청 URL을 알아낸다.

PAC파일은 js로 되어있으며 함수를 통해 URL을 알아낸다.

### 5.3 웹 프록시 자동발견 프로토콜(WPAP)

웹브라우저가 근처의 프록시를 찾아내는 방법이다.

- PAC파일 자동 발견 : HTTP 클라이언트가 PAC을 찾아 URL을 얻도록 해준다.
    - WPAD를 통해 PAC 를 찾는다.
    - PAC 파일을 실행해서 찾은 프록시 URL에 요청을 보낸다.
- WPAD 알고리즘 : PAC파일 CURL을 결정하기 위해 여러가지 기법을 사용한다. 위에서부터 순서대로 시도한다.
    - DHCP (동적 호스트 설정 프로토콜)
    - SLP (서비스 위치 프로토콜)
    - DNS
    - DNS의 SRV 레코드
    - TXT 레코드의 DNS 서비스 URL
- DHCP를 이용한 CURL 발견 : WPAD 클라이언트가 질의하는 DHCP 서버는 반드시 CURL을 갖고있어야 한다.
- DNS A 레코드 룩업 : 알맞은 프록시 서버의 IP 주소가 질의하는 DNS 서버에 저장되어 있어야 한다.
- PAC 파일 가져오기 : CURL이 생성되면 이를 통해 Accept 헤더를 포함한 GET 요청을 보낸다.
- WPAD 실행 시점
    - 웹 클라이언트가 시작될 때 (PAC 파일이 만료되어 재시작 할 때)
    - 클라이언트 호스트의 IP 주소가 변경된 네트워킹 스택으로부터 언급이 있을 때
- WPAD 스푸핑 : WPAD는 3차 도메인에 도달할 때 까지 서브 도메인을 지워 질의하는데, 이는 신뢰하기 어려워 IE 5.01 이후에 바로잡았다.
- 타임 아웃  : WPAD 단계는 여러개가 있다. 구현자는 네트워크 특성에 맞는 값을 선택할 수 있다.
- 관리자 고려사항
    - 클라이언트 호환을 위해 DHCP, DNS A중 하나는 반드시 구현해야 한다.
    - 가까운 프록시를 찾도록 도와줘야 한다. (DHCP 서브넷 구분, DNS 접미사 구분, CURL 요청 헤더 결정등)

## 6. 캐시 리다이렉션 방법

### 6.1 WCCP 리다이렉션

웹 트래픽을 프록시 캐시로 리다이렉트 하는 프로토콜이다. 

- WCCP 리다이렉션 동작
    - WCCP를 사용할 수 있는 라우터와 캐시와 의사소통이 되는 캐시를 가진 네트워크가 필요하다.
    - 라우터 집합과 대상이 되는 캐시들이 WCCP 서비스 그룹을 구성하여 트래픽과, 캐시분산에 대해 명시한다.
    - HTTP 요청을 처리하기 위한 서비스 그룹 캐시를 선택한다. (리다이렉트시 해당하는 주소에 캐시를 보낸다)
    - 캐시 요청을 처리할 수 없을 때 패킷은 라우터로 포워딩 된다.
- WCCP2 메시지
    - WCCP2_HERE_I_AM : 캐시가 라우터에게 트래픽을 받을 수 있다고 보내는 메시지다.
    - WCCP2_I_SEE_YOU : 라우터가 캐시에게 HERE_I_AM에 응답하는 메시지다.
    - WCCP2_REDIRECT_ASSIGN : 지정된 캐시가 라우터에게 부하균형을 할당한다.
    - WCCP2_REMOVAL_QUERY : 라우터가 HERE_I_AM을 보내지 않은 캐시에게 그룹에서 제거해야 하는지 질의를 한다.
- 메시지 구성요소 : WCCP2 메시지는 헤더와 구성요소로 구분된다.
    - 보안정보 : 보안옵션을 담고있다.
    - 서비스 정보 : 서비스 그룹을 서술한다.
    - 이 외에도 여러가지가 있지만, 위 두가지 정보는 공통으로 사용된다.
- 서비스 그룹 : WCCP 메시지를 교환할 수 있는 라우터와 캐시로 구성되어 있다.
- GRE 패킷 캡슐화 : IP 주소와 함께 캡슐화 해 서버로 리다이렉트 한다. 캡슐화된 IP는 중간에 누락되거나 변경되지 않는다.
- WCCP 부하 균형 :  라우팅과 서버 간 부하 균형을 유지할 수 있다.

## 7. 인터넷 캐시 프로토콜 (ICP)

ICP는 캐시 적중률을 찾아볼 수 있도록 해준다. 캐시는 원서버보다 근처 캐시에서 값을 가져오는게 비용이 저렴하다 판단하여 캐시에서 컨텐츠를 가져온다. 캐시 클러스터링이라 생각해도 좋다.

ICP가 근처 캐시에게 특정 URL 정보를 요청하면 HIT 또는 MISS로 응답한다. HIT한 캐시에 커넥션을 연다.

ICP는 32비트 크기의 UDP 프로토콜을 사용하여 매우 가볍다.

- OP 코드 : 메시지의 의미를 서술하는 8비트 값
- 버전 : ICP 프로토콜 버전 번호를 서술하는 8비트 값
- 메시지 길이 : 메시지의 총 길이를 나타낸 것
- 요청 번호 : 여러 요청과 응답을 추적하기 위해 요청 번호를 사용한다.
- 옵션 : ICP 동작을 변경하는 비트벡터
- 옵션 데이터 : 근처 캐시로부터 원서버까지 왕복 시간 측정 값을 담아놓는 32비트 값
- 발송자 호스트 주소 : 32비트 IP주소를 갖고 있는 필드 (사용되지않음)
- 페이로드 : URL + 16비트 객체 크기 + 객체 데이터

## 8. 캐시 배열 라우팅 프로토콜(CARP)

프록시 서버에 들어오는 부하를 분산하기 위해 사용되는 프록시 서버를 늘릴 수 있다.

CARP는 ICP의 대안으로 캐시 배열이 클라이언트 시점에 하나의 논리적인 캐시처럼 보이도록 관리된다.

ICP에서 근처 캐시가 MISS 된다면 또 다른 캐시에 요청을 하게 되는데, 이를 줄여준다.

동작 방식

- 각 서버가 캐시 문서 일부만 갖고 있다. (겹치지 않고 독립적임)
- 한 번에 검색만으로 객체의 위치를 알 수 있다.
- 참여하는 프록시 테이블을 유지하고, 헬스 체크를 한다.(테이블엔 TTL, 부하핸들링을 명시)
- 각 서버에 대해 해시 함수를 계산하여 처리할 수 있는 부하의 양을 계산에 넣는다.
- 요청된 웹 객체의 URL에 근거한 숫자값을 반환하는 분리된 해시 함수를 정의한다.
- URL 해시 함수와 프록시 서버 해시 함수로 사용될 프록시 서버를 결정한다.

단점으로 프록시 서버중 문제가 생긴다면 콘텐츠를 재배치 해야 해서 비용이 비싸진다.

## 9. 하이퍼텍스트 캐싱 프로토콜(HTCP)

HTTP 1.0 이후에선 ICP로 정환한 응답을 가져올 수 없다. HTCP는  형제 캐시를 조회 뿐만 아니라 서로의 문서를 추가, 삭제, 모니터링 할 수 있다.

HTCP는 ICP보다 요청과 응답이 상세하다.

- 메시지 길이, 주/부 버전, 데이터 길이, OP코드, 응답코드, 예약, F1 플래그, RR플래그, 트랜잭션 ID 코드데이터, 인증정보 등등
- HTCP 메시지 인증은 선택적이다. (인증 길이, Sig 시간, Sig 만료, 키 값, 서명)
- 캐싱 정책 설정 헤더 (Cache_Vary, Cache-Location, Cache-Policy, Cache-Flags, Cache-Expiry, Cache-MD5, Cache-to-Origin)

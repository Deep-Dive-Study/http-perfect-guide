# 17. 내용 협상과 트랜스 코딩

한 URL에서 여러 리소스에 대응할 때 내용 협상을 통해 적합한 리소스를 반환한다.

## 내용 협상 기법은 세가지가 있다.

### 1. 클라이언트 주도 협상

- 클라이언트가 요청할 때 가능한 페이지 목록을 응답으로 반환 한다.
- 클라이언트는 목록중 하나를 고른다.

장단점

- 구현하기 쉽다.
- 느리다.

### 2. 서버 주도 협상

- 서버는 내용 협상 헤더를 살펴보고 그에 알맞는 응답 헤더를 준비한다.
- 내용 협상 헤더 외에 다른 헤더를 기반하여 응답을 준비한다.
    - Accept, Accpet-Language, Accept-Charset 등등

장단점

- 클라이언트는 자신의 선호 정보를 매 요청마다 보내야 한다.
- 커뮤니케이션 대기시간이 줄어든다.

**내용 협상 헤더 품질값 :** Accept-Language 헤더에 여러 언어와 q값을 보낼 수 있다.

**다른 헤더 :** User-Agent와 같은 요청 헤더를 이용해 응답을 준비한다.

**아파치 내용 협상** : 

- 컨텐츠 제공자는 각각의 버전에 해당하는 파일들을 아파치 서버에 적절한 디렉토리에 넣어둔 뒤 type-map을 만든다.
- type-map을 기반으로 클라이언트에게 필요한 리소스를 제공한다.
- MultiView를 사용해도 된다.

### 3. 투명 협상

협상 프록시를 둠으로 클라이언트와의 메시지 교환을 최소화 한다.

- 프록시는 클라이언트의 기대를 알고 협상한다.
- 서버는 프록시에게 어떤 헤더를 검사해야하는지 말해줘야 한다.
- 캐시 프록시는 단일 URL을 통해 접근할 수 있는 여러 사본을 저장하는 방법이다.
    - 캐시는 서버 입장에서 클라이언트와 협상한다.
    - 캐시에 설치되어 있는 범용 트랜스 코더는 특정 서버에 국한되지 않는다.

**캐시와 얼터네이트 :** 캐시된 컨텐츠의 의사결정 로직은 대부분 그대로 사용한다. 

- 캐시는 응답을 돌려보낼 때 서버로부터 안내받은 헤더를 사용해야 한다.

**Vary 헤더** : 서버가 문서를 선택하거나 커스텀 컨텐츠를 생성할 떄 고려한 요청헤더를 나열한다.

- User-Agent, Accpet외에 다른 헤더로 이루어졌을 경우 무엇인지 알아야 하고 캐시된 페이지중 어떤 페이지를 반환할지 선택해야 한다.
- Vary 헤더가 존재한다면 반드시 Vary헤더와 새요청과 오래된 캐시요청에서 맞아야 한다.

## 5. 트랜스 코딩

트랜스 코딩 : 서버가 클라이언트의 요구에 맞는 문서를 갖고있지 않을때 기존의 문서를 클라이언트가 사용할 수 있는 무언가로 바꾸는 행위

(ex. HTML → WML, 고해상도이미지 → 저해상도이미지)

- 포맷 변환 : 데이터를 클라이언트가 볼 수 있도록 변환하는 행위
- 정보 합성 : 문서의 요점을 추출하는 것 (개요 생성, 광고 제거 등)
- 컨텐츠 주입 : 문서의 양을 늘리는 변환 (광고 생성, 사용자 추적 시스템)

### 트랜스코딩 vs 정적으로 미리 생성해두기

정적으로 만드는 것은 현실적으로 불가능하다. (공간부족, 등등)

따라서 그때그때 트랜스코딩 하는 방식이 더 편하지만, 병목현상이 생길 수 있다. 이는 때때로 제3자에게 계산을 이관시켜 부담을 덜어낼 수 있다.

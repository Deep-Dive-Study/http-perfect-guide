# 5. 웹서버

# 5.1 다채로운 웹 서버

웹 서버 : 웹 서버 SW와 관련 장비 모두를 뜻한다. 기능, 크기, 형태 별로 다양하다.

### 구현

웹서버는 HTTP와 관련 TCP 처리를 구현한 것이다.

- HTTP 프로토콜 구현
- 웹 리소스 및 서버 관리 기능
- TCP 커넥션 관리

웹 서버는 다목적 소프트웨어 웹 서버 위에서 구동한다. (apache, nginx등)

간단한 프린터나 가전제품은 간단한 임베디드 서버로 관리한다.

# 5.2 웹 서버

서버가 갖추어야 할 일은 다양하지만, 가장 기본적인 사항은 다음과 같다.

- 커넥션 수락
- TCP 소켓 생성 및 커넥션
- 요청을 읽고, 처리(리소스) 후 응답
- 로깅

![image](https://github.com/Deep-Dive-Study/http-perfect-guide/assets/85796588/e9f17af4-4666-4517-960f-ad2936609799)

### 클라이언트 커넥션

기존 커넥션 : 지속적 커넥션이 있다면, 그 커넥션을 사용한다.

새 커넥션 : 새 커넥션이 생기면 커넥션 목록에 추가한다.

클라이언트 호스트 식별 : DNS를 사용해 IP주소를 호스트명으로 변환한다. (호스트 룩업은 지연을 야기한다)

indent : 서버에게 HTTP 커넥션을 초기화한 사용자 이름을 얻는 프로토콜이다.

- TCP 포트 113번을 통해 요청한다. 다만 지원하지 않는 서버가 많다.

### 요청 메시지 수신

커넥션을 통해 데이터가 저장되면, 웹 서버는 커넥션에 데이터를 읽어들여 파싱하고 요청 메시지를 구성한다.

- 파싱 후 지정된 리소스의 URI, 버전 번호, 캐리지 리턴을 확인하고 찾는다.
- 헤더를 읽는다.
- 본문을 읽는다.

커넥션 I/O 아키텍처

![image](https://github.com/Deep-Dive-Study/http-perfect-guide/assets/85796588/ac3a8707-b4d7-4845-a7d4-ae26f81e9e25)

많은 웹서버는 다중 I/O 아키텍처를 채택했다. 왜냐하면 스레드와 프로세스는 유휴 상태의 커넥션에게 리소스를 낭비하지 않기 때문이다.

다중 멀티스레드 I/O 아키텍처는 각각 열려있는 커넥션을 감시하고 조금씩 작업을 수행한다. (현재는 이 아키텍처 또는 비동기 I/O가 가장 많이 쓰인다.)

* 비동기 I/O 아키텍처 : 이벤트 발생에 따라 작업을 수행하며, 주로 콜백(callback) 함수를 사용하여 비동기적으로 작업을 처리한다. (확장성, 효율성 증가)

### 리소스 매핑과 접근

Docroot : 간단하게 URI를 그대로 사용해서 리소스의 위치를 문서 루트로부터 찾는 것이다.

- 가상 호스팅 docroot : 한 서버에서 여러 호스팅으로 컨텐츠를 분리할 수 있다.

디렉토리 목록 : 경로가 파일이 아닌 디렉토리를 가르키는 경우 여러가지 행동중 하나를 선택한다.

- 에러 반환
- 색인 파일 반환
- 디렉토리 내용을 담은 HTML 반환

**동적 콘텐츠 리소스 매핑**

웹 서버는 동적 리소스를 URI에 맞게 매핑할 수 있다.

예를 들어 정적 리소스 외에도 요청에 따른 게이트웨이를 애플리케이션 서버에 매핑할 수 있다.

경로에 대응하는 디렉토리에 프로그램을 찾아 실행하는 방식인데 여기에 CGI같은 인터페이스가 있다.

**접근 제어**

각 리소스별 접근 제어를 할당할 수 있다. 해당하는 리소스에 대한 요청이 도착했을 때 웹 서버는 클라이언트 IP에 근거하여 제어한다.

### 응답 만들기

응답 엔티티 : Content-Type, Content-Length 헤더와 본문을 포함한다.

MIME타입 결정

- 파일 확장자
- 매직 타이핑 : 파일 내용에서 특정 패턴 발견
- 유형 명시 : 웹 서버 설정으로 MIME 타입 지정
- 유형 협상 : 리소스가 여러 형식에 속할 수 있고, 사용자와 협상을 통해 형식을 판별하게도 가능하다.

리다이렉션은 다음과 같은 상황에 유용하다.

- 영구히 리소스가 옮겨진 경우
- 임시로 리소스가 옮겨진 경우
- URL 증강 : 서버 상태 정보를 포함해서 리다이렉트 시키는 경우
- 로드 밸런싱 : 다른 서버로 리다이렉트
- 디렉터리 이름 정규화

### 응답 보내기

응답을 보내기 전에 커넥션 상태를 추적하여 보내야 한다. 이때 굉장히 각별한 주의가 필요한데, 지속적 커넥션인 경우 Content-Length 계산이 꼬일 수 있다.

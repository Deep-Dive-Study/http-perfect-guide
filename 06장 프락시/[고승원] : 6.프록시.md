# 6. 프록시

웹 프록시는 서버 중개자를 뜻한다. 클라이언트와 서버 사이에서 HTTP 메시지를 정리하는 중개인처럼 동작한다.

# 1. 웹 중개자

프록시는 웹 서버의 역할과 웹 클라이언트의 역할을 모두 한다.

### 개인 프록시와 공유 프록시

- 개인 프록시
    
    클라이언트 컴퓨터에서 직접 실행되는 형태로 사용된다. ISP서비스나, 광고에 사용된다.
    
- 공유 프록시
    
    대부분의 프록시를 뜻하며 중앙 집중형으로 관리되어 비용 효율이 높고 쉽다.
    
    사용자가 많을수록 유리하다.
    

### 프록시 대 게이트웨이

프록시는 같은 프로토콜을 사용하는 둘 이상의 애플리케이션을 연결한다.

게이트웨이는 서로 다른 프로토콜을 사용하는 둘 이상의 애플리케이션의 변환기로 동작한다.

# 2. 왜 프록시를 사용하는가?

프록시 사용 이유

- 보안 개선
    - 필터 기능
    - 접근 제어
    - 보안 방화벽 : 프로토콜 흐름에서 통제 및 바이러스 제거, 트래픽 훅 제공
    - 익명화 프록시 : HTTP의 신원 식별자들을 없엔다.(IP, From헤더, Refer, 쿠키, URI등)
- 성능 증가
    - 웹 캐시 : 인기 있는 로컬 문서의 사본을 관리한다.
    - 대리(리버스) 프록시 : 웹 서버로 위장하여 콘텐츠를 찾기 위해 다른 웹 서버와 커뮤니케이션 한다. 서버 가속기로도 불린다.
    - 콘텐츠 라우터 : 트래픽 조건과 콘텐츠 종류에 따라서 특정 웹 서버로 유도한다.
- 비용 절약
    - 트랜스코더 : 클라이언트에게 전달하기 전에 포맷을 수정한다. (크기를 줄이기 위해 압축하거나 콘텐츠 자료형을 변경하기도 한다.)

# 3. 프록시는 어디에 있는가?

* ISP : 인터넷 서비스 제공자

### 프록시 서버 배치

- 출구 프록시 : 로컬 네트워크와 인터넷 사이에서 네트워크의 출구에서 프록시를 사용한다. (방화벽, 트래픽 성능 개선, 컨텐츠 필터링)
- 입구 프록시 : 고객의 모든 요청을 종합적으로 처리하기 위해 ISP 접근 지점에 위치 (속도 개선, 대역폭 비용 절감, 캐시)
- 대리(리버스) 프록시 : 웹 서버 바로 앞에 위치한다. (보안, 캐시)
- 네트워크 교환 프록시 : 인터넷 교차로에 위치한다. (트래픽 감시, 혼잡 완화)

### 프록시 계층

프록시 계층에서 메시지는 프록시를 거쳐 이동하고 돌아온다. 인바운드 프록시를 부모 프록시, 아웃바운드 프록시는 자식 프록시로 불린다.

- 프록시 계층의 콘텐츠 라우팅 : 프록시 계층인 경우엔 요청 순서가 변하지 않는다. 유동 프록시 서버도 있다.
    - 판단에 의해 유동 프록시를 이용하는데, 보통 콘텐츠 분산이나, 캐시에 사용된다.
        - 판단되는 요소는 다음과 같다. (부하 균형, 지리적 라우팅, 프로토콜 타입 라우팅, 빠른 라우팅)

### 프록시가 트래픽을 처리하는 방법

- 클라이언트 수정 : 일반적인 상황에서 원 서버가 아닌 원 서버의 프록시에게 요청을 보낸다.
- 네트워크 수정 : 클라이언트가 모르게 네트워크 인프라로 가로채 프록시에게 요청을 보낸다. (인터셉트 프록시)
- DNS 이름 수정 : 웹 서버의 이름과 IP주소를 프록시가 직접 사용한다.
- 웹 서버 수정 : 리다이렉션 명령을 통해 프록시로 리다이렉트 하도록 한다.

# 4. 클라이언트 프록시 설정

- 수동 설정
- 브라우저 기본 설정 : 브라우저나 클라이언트에서 프록시를 미리 설정해 놓을 수 있다.
    - 이 방법은 단순하나, 유연성이 떨어진다.
- 프록시 자동 설정(PAC) : JS의 PAC 파일에 대한 URI를 제공할 수 있다.
    - 브라우저 기본 설정에 대한 동적 해결 방법이다. JS파일을 사용해 그때그때 프록시를 계산한다.
    - FindProxyForUrl(url, host) 함수를 정의해야한다.
- WPAD 프록시 : 프록시 자동 발견 프로토콜
    - PAC 파일을 자동으로 찾아주는 알고리즘. (DHCP, SLP, DNS호스트명, DNS SRV, DNS TXT등)

# 5. 프록시 요청의 특징

### 프록시 URL과 서버 URL

클라이언트가 웹 서버로 요청을 보낼 때 스킴, 호스트, 포트 번호가 없는 부분 URI를 가지고, 프록시로 요청을 보낼 때 완전한 URI를 가진다.

기존의 서버와 클라이언트는 직접 대화 했기에 스킴과 호스트 포트번호등은 이미 알고있어 없이도 대화가 됐다.

프록시가 생기며, 프록시와 서버 커넥션을 생성하기 위해 URI를 모두 알아야 한다.

### 가상 호스팅에서 일어나는 문제

가상 호스팅이 되는 웹서버는 여러 사이트가 같은 물리적 웹서버를 공유한다.

따라서 접근하고자 하는 웹의 호스트명을 알아야 한다. 이는 두 가지 방법을 사용한다.

- 요청 메시지가 완전한 URI를 갖도록 한다.
- 헤더에 호스트와 포트에 대한 정보를 담는다.

### 인터셉트 프록시는 대부분 URI를 받는다.

완전한 URI를 받는다고 모든 문제가 해결되는 것은 아니다. 몇몇 프록시는 클라이언트에게 보이지 않기 때문이다.

즉 프록시를 인지하지 못하고, 웹 서버와 대화하고 있다 판단해 URI를 보내지 않을 수 있다.

### 프록시는 프록시 요청과 서버 요청 모두 다룰 수 있다.

완전한 URI, 부분 URI 모두 처리할 수 있어야 한다.

### 전송 중 URI 변경

URI 변경으로 다운스트림 서버와 상호 운용성 문제가 생길 수 있다.

프록시 서버는 프로토콜을 처리할 때 가능한 관대하게 처리해야 한다.

### URI 클라이언트 자동확장과 호스트 명 분석

1. 프록시가 없다면 URI를 통해 IP주소를 찾는다.
2. 호스트가 발견되지 않는다면, 자동화된 호스트 명에 대해 확장 시도한다.

### 프록시 없는 URI 분석

호스트명 자동 확장 플로우를 사진 한 장으로 이해할 수 있다.

![image](https://github.com/Deep-Dive-Study/http-perfect-guide/assets/85796588/7dcc7511-239d-44c7-85c9-87275b9f0784)

### 명시적인 프록시 사용시 URI 분석

명시적인 프록시는 자동확장을 사용하지 못한다.

![image](https://github.com/Deep-Dive-Study/http-perfect-guide/assets/85796588/51284949-528b-4d00-acec-850450261e2b)

### 인터셉트 프록시 사용시 URI 분석

클라이언트는 인터셉트 프록시를 볼 수 없어서 DNS가 성공할 때 까지 호스트명을 확장한다.

클라이언트 입장에서 서버를 찾았다고 생각할 때, 인터셉터가 가로챈다.

# 6. 메시지 추적

### Via 헤더

메시지가 지나가는 중간 노드를 나열한다. 노드를 지날때 목록 끝에 콤마와 자신을 추가한다.

메시지의 전달을 추적하고, 루프를 진단하는데 사용된다.

각 경유지는 프록시나 게이트웨이 홉을 나타내며, 중간 노드의 프로토콜과 주소 정보도 갖고 있다.

문법은 다음과 같으며 순서대로 적는다.

- 프로토콜 이름(선택)
- 프로토콜 버전
- 노드 이름(선택, 기본값 있음)
- 노드 코멘트(선택)

Via 헤더는 TCP 커넥션을 오갈 때 요청과 같은 경로로 반환되도록 한다.

몇몇 프록시에서 프로토콜을 변환하기도 하는데 이또한 Via 헤더에 담긴다.

프록시가 방화벽처럼 사용되는 경우 보안을 위해 Via 헤더를 가명으로 사용하거나 합쳐서 사용한다.

- 가명이 아닌 이상 합쳐서 안된다.

### Server 헤더

응답 헤더 필드에 담기며, 원 서버에 의해 사용되는 소프트웨어를 알려준다. (Apache, Netscape등등)

### TRACE 메서드

프록시 서버는 메시지를 변환할 수 있다. (헤더, 본문 등등)

HTTP의 TRACE 메서드는 요청 경로를 알기위해 사용된다.

- Max_Forwards : 요청 과정에 생기는 홉의 개수를 제한한다. 루프를 찾기 위해 사용

# 7. 프록시 인증

접근 제어 장치로 사용될 때 접근 권한이 없으면 프록시에서 컨텐츠를 차단한다.

1. 407 Proxy Authorization Required 상태 코드와 Proxy-Authenticate 헤더를 통해 자격 제출에 대한 설명을 한다.
2. 클라이언트는 사용자를 통해 요구되는 자격을 수집해 헤더에 담아 요청한다.

# 8. 프록시 상호운용성

프록시는 클라이언트와 서버 사이를 중개해야 한다.

- 지원하지 않는 헤더와 메서드 다루기 : 이해할 수 없는 필드나 헤더는 다음 홉으로 그대로 전달해야 한다.
- OPTIONS 메서드 : 웹 서버의 특정 리소스가 어떤 기능을 지원하는지 알아볼 수 있게 해준다.
- Allow 헤더 : 식별되는 자원에 대해 지원되는 메서드나 서버가 원하는 모든 메서드를 열거한다.
